name: SonarQube Code Quality - Django Backend

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  sonarqube:
    runs-on: ubuntu-latest

    steps:
      # ✅ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # ✅ Debug: Check directory structure
      - name: Debug Directory Structure
        run: |
          pwd
          ls -la

      # Add sonar-project.properties file
      - name: Configure SonarQube
        run: |
          echo "sonar.projectKey=Genback-ai" > sonar-project.properties
          echo "sonar.projectName=Genback-ai" >> sonar-project.properties
          echo "sonar.projectVersion=1.0" >> sonar-project.properties
          echo "sonar.sourceEncoding=UTF-8" >> sonar-project.properties
          echo "sonar.sources=src" >> sonar-project.properties
      # Run SonarQube Scan
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v1.0.0
        env:
          SONAR_HOST_URL: https://sonarq.synchroni.xyz
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_GENBACKAI }}
        with:
          args: -Dsonar.projectKey=Genback-ai -Dsonar.projectBaseDir=src

      # Check SonarQube Quality Gate Status
      - name: Verify SonarQube Quality Gate
        run: |
          echo "Checking SonarQube Quality Gate Status..."
          sleep 10  # Wait for SonarQube to process the results
          
          STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN_GENBACKAI }}: \
            "https://sonarq.synchroni.xyz/api/qualitygates/project_status?projectKey=Genback-ai" | jq -r '.projectStatus.status')
          echo "Quality Gate Status: $STATUS"
          if [[ "$STATUS" == "ERROR" ]]; then
            echo "SonarQube Quality Gate Failed! Blocking merge."
            exit 1
          else
            echo "SonarQube Quality Gate Passed!"
          fi
      # Send Notification to Teams
      - name: Send Notification to Teams
        run: |
          SONARQUBE_REPORT_URL="https://sonarq.synchroni.xyz/dashboard?id=Gen-ai"
          
          curl -H "Content-Type: application/json" -d '{
            "title": "SonarQube Scan Completed",
            "text": "SonarQube scan completed for Genback-ai. Click the link below to view the report.",
            "sections": [
              {
                "text": "Quality Gate: '"$STATUS"'"
              }
            ],
            "potentialAction": [
              {
                "@type": "OpenUri",
                "name": "View Report",
                "targets": [
                  {
                    "os": "default",
                    "uri": "'"${SONARQUBE_REPORT_URL}"'"
                  }
                ]
              }
            ]
          }' ${{ secrets.TEAMS_WEBHOOK_URL }}
